<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Yanri's Guestbook - Sign my guestbook and leave a message!" />
    <title>Yanri's Website - Guestbook</title>
    <link rel="icon" type="image/jpeg" href="images/icon.jpg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <link href="style.css" rel="stylesheet" type="text/css" />
    <script src="https://w.soundcloud.com/player/api.js"></script>
</head>

<body>
    <!-- Corner Symbols -->
    <img src="images/mysimbol.gif" alt="Symbol" class="corner-symbol top-left" />
    <img src="images/mysimbol.gif" alt="Symbol" class="corner-symbol top-right" />

    <!-- SoundCloud Player Widget -->
    <div class="video-player-widget">
        <div class="video-player-frame">
            <iframe id="soundcloud-player" width="260" height="160" scrolling="no" frameborder="no" allow="autoplay"
                src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/yanri-risk/sets/stop-making-fun-of-me&color=%23556b2f&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false">
            </iframe>
        </div>
    </div>

    <!-- Mozzart Window - Bottom Left -->
    <div class="mozzart-window">
        <h3>THIS IS MOZZART</h3>
        <img src="images/mozzart.jpg" alt="Mozzart" onclick="playMozzartAudio()" />
        <audio id="mozzart-audio" src="images/Jasmin China Girl [xe4APfSQRYQ].ogg"></audio>
    </div>

    <!-- Forpooper Image - Right Side -->
    <img src="images/forpooper.png" alt="For Pooper" class="forpooper-img" />
    <img src="images/g9en3ts7nw781.png" alt="" class="g9en3ts7nw781-img" />

    <div id="container">
        <!-- Header Banner -->
        <div id="header">
            <img src="images/yanribanner.png" alt="Yanri's Website" />
        </div>

        <!-- Horizontal Menu -->
        <div id="menu">
            <ul>
                <li><a href="index.html">About Me...</a></li>
                <li><a href="art.html">Art</a></li>
                <li><a href="music.html">Music</a></li>
                <li><a href="interests.html">Interests</a></li>
                <li class="active"><a href="guestbook.html">Guestbook</a></li>
            </ul>
        </div>

        <!-- Content Wrapper (Sidebar + Main) -->
        <div id="content-wrapper">
            <!-- Sidebar (Left) -->
            <div id="sidebar">
                <h3>Links</h3>
                <ul>
                    <li><a href="https://x.com/ASwindlr" target="_blank">Twitter</a></li>
                    <li><a href="#">YouTube</a></li>
                </ul>

                <h3>Contact</h3>
                <ul>
                    <li><a href="#">Email Me</a></li>
                    <li><a href="#">Discord</a></li>
                </ul>
            </div>

            <!-- Main Content (Right) -->
            <div id="main-content">
                <h2>Guestbook</h2>
                <p>Sign my guestbook! Leave a message and let me know you were here!</p>

                <p id="storage-notice" style="color: OliveDrab; font-size: 11px; font-style: italic;"></p>

                <!-- Guestbook Form -->
                <div class="guestbook-form">
                    <h3>Leave a Message</h3>
                    <form id="guestbook-form">
                        <div class="form-group">
                            <label for="name">Name:</label>
                            <input type="text" id="name" name="name" required maxlength="50" />
                        </div>

                        <div class="form-group">
                            <label for="message">Message:</label>
                            <textarea id="message" name="message" rows="4" required maxlength="500"></textarea>
                        </div>

                        <button type="submit" class="submit-btn" id="submit-btn">Sign Guestbook</button>
                    </form>
                </div>

                <!-- Guestbook Entries -->
                <div class="guestbook-entries">
                    <h3>Messages (<span id="entry-count">0</span>)</h3>
                    <div id="entries-container">
                        <p class="no-entries">Loading messages...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div id="footer">
            <p>Copyright &copy; 2024 Yanri. All rights reserved.</p>
        </div>
    </div>

    <script src="guestbook-config.js"></script>
    <script>
        // Mozzart Audio Player
        function playMozzartAudio() {
            var audio = document.getElementById('mozzart-audio');
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        // SoundCloud Widget API
        var iframe = document.querySelector('#soundcloud-player');
        var widget = SC.Widget(iframe);

        widget.bind(SC.Widget.Events.READY, function () {
            widget.setVolume(20);

            var savedPosition = sessionStorage.getItem('sc_position');
            var savedTrack = sessionStorage.getItem('sc_track');
            var wasPlaying = sessionStorage.getItem('sc_playing') === 'true';

            if (savedPosition && savedTrack) {
                widget.getSounds(function (sounds) {
                    var trackIndex = parseInt(savedTrack);
                    if (trackIndex >= 0 && trackIndex < sounds.length) {
                        widget.skip(trackIndex);
                        widget.seekTo(parseInt(savedPosition));
                        if (wasPlaying) {
                            widget.play();
                        }
                    } else if (wasPlaying) {
                        widget.play();
                    }
                });
            }
        });

        window.addEventListener('beforeunload', function () {
            widget.getPosition(function (position) {
                sessionStorage.setItem('sc_position', position);
            });
            widget.getCurrentSoundIndex(function (trackIndex) {
                sessionStorage.setItem('sc_track', trackIndex);
            });
            widget.isPaused(function (paused) {
                sessionStorage.setItem('sc_playing', !paused);
            });
        });

        // Guestbook Functionality
        const guestbookForm = document.getElementById('guestbook-form');
        const entriesContainer = document.getElementById('entries-container');
        const entryCount = document.getElementById('entry-count');
        const submitBtn = document.getElementById('submit-btn');
        const storageNotice = document.getElementById('storage-notice');

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Display entries
        function displayEntries(entries) {
            entriesContainer.innerHTML = '';
            entryCount.textContent = entries.length;

            if (entries.length === 0) {
                entriesContainer.innerHTML = '<p class="no-entries">No messages yet. Be the first to sign!</p>';
                return;
            }

            // Display entries in reverse order (newest first)
            entries.slice().reverse().forEach(function (entry) {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'guestbook-entry';

                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                entryDiv.innerHTML =
                    '<div class="entry-header">' +
                    '<strong>' + escapeHtml(entry.name) + '</strong>' +
                    '<span class="entry-date">' + dateStr + '</span>' +
                    '</div>' +
                    '<div class="entry-message">' + escapeHtml(entry.message) + '</div>';

                entriesContainer.appendChild(entryDiv);
            });
        }

        // LOCAL STORAGE FUNCTIONS
        function loadEntriesLocal() {
            const entries = JSON.parse(localStorage.getItem('guestbook_entries') || '[]');
            storageNotice.textContent = '⚠ Using local storage - messages only visible on this device. See GUESTBOOK_SETUP.md to enable online sharing.';
            displayEntries(entries);
        }

        function saveEntryLocal(name, message) {
            const entries = JSON.parse(localStorage.getItem('guestbook_entries') || '[]');
            entries.push({
                name: name,
                message: message,
                timestamp: Date.now()
            });
            localStorage.setItem('guestbook_entries', JSON.stringify(entries));
            loadEntriesLocal();
        }

        // JSONBIN FUNCTIONS
        function loadEntriesOnline() {
            storageNotice.textContent = '✓ Online mode - messages visible to everyone!';

            fetch(GUESTBOOK_BIN_URL, {
                method: 'GET',
                headers: {
                    'X-Master-Key': JSONBIN_API_KEY
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load from JSONbin');
                    }
                    return response.json();
                })
                .then(data => {
                    const entries = data.record.entries || [];
                    displayEntries(entries);
                })
                .catch(error => {
                    console.error('Error loading entries:', error);
                    storageNotice.textContent = '⚠ Error connecting to online storage. Falling back to local mode.';
                    loadEntriesLocal();
                });
        }

        function saveEntryOnline(name, message) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Posting...';

            fetch(GUESTBOOK_BIN_URL, {
                method: 'GET',
                headers: {
                    'X-Master-Key': JSONBIN_API_KEY
                }
            })
                .then(response => response.json())
                .then(data => {
                    const entries = data.record.entries || [];
                    entries.push({
                        name: name,
                        message: message,
                        timestamp: Date.now()
                    });

                    return fetch(GUESTBOOK_BIN_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        body: JSON.stringify({ entries: entries })
                    });
                })
                .then(response => response.json())
                .then(data => {
                    loadEntriesOnline();
                    guestbookForm.reset();
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign Guestbook';

                    setTimeout(function () {
                        entriesContainer.scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                })
                .catch(error => {
                    console.error('Error saving entry:', error);
                    alert('Error posting online. Saving locally instead.');
                    saveEntryLocal(name, message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign Guestbook';
                });
        }

        // Handle form submission
        guestbookForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const name = document.getElementById('name').value.trim();
            const message = document.getElementById('message').value.trim();

            if (name && message) {
                if (USE_LOCAL_STORAGE) {
                    saveEntryLocal(name, message);
                    guestbookForm.reset();
                    setTimeout(function () {
                        entriesContainer.scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                } else {
                    saveEntryOnline(name, message);
                }
            }
        });

        // Load entries on page load
        if (USE_LOCAL_STORAGE) {
            loadEntriesLocal();
        } else {
            loadEntriesOnline();
            // Refresh entries every 30 seconds when online
            setInterval(loadEntriesOnline, 30000);
        }
    </script>

</body>

</html>